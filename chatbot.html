<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Financial Consultant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for the app container */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .app-container {
            max-width: 768px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 4px 40px rgba(0, 0, 0, 0.15);
            border-radius: 0.5rem;
        }
        /* Chat specific styles */
        .message-box {
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            max-width: 85%;
            word-wrap: break-word;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.05));
        }
        .user-message {
            background-color: #059669; /* Emerald Green */
            color: white;
            margin-left: auto;
        }
        .assistant-message {
            background-color: #d1d5db; /* Light gray */
            color: #1f2937;
            margin-right: auto;
            text-align: left;
        }
        .chat-area {
            flex-grow = 1;
            padding: 1rem;
            overflow-y: auto;
        }
        .input-area {
            background-color: #f9fafb;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        /* Loading Indicator */
        .loading-dot {
            width: 10px;
            height: 10px;
            background-color: #059669;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .loading-dot:nth-child(2) { animation-delay: -0.4s; }
        .loading-dot:nth-child(3) { animation-delay: -0.8s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
        }

        /* Microphone Button Style */
        .mic-listening {
            background-color: #b91c1c; /* Red-700 */
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(248, 113, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); }
        }

        /* Dashboard specific styles */
        .dashboard-container {
            min-height: calc(100vh - 100px);
            padding: 1rem;
            color: #333;
        }
        .triangle-svg-wrapper {
            width: 100%;
            max-width: 350px;
            height: auto;
            margin: 0 auto 1rem;
        }
        .metric-card {
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        /* D3 Chart Specific Styles */
        .chart-container svg {
            overflow: visible; /* Allows axes labels to show */
        }
        .chart-container .overlay {
            fill: none;
            pointer-events: all;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Header & Navigation -->
    <header class="bg-emerald-600 text-white shadow-lg flex-shrink-0 rounded-t-lg">
        <h1 class="text-2xl font-bold p-3">AI Financial Consultant</h1>
        <div class="flex border-t border-emerald-700">
            <button id="chat-tab" onclick="switchView('chat')" class="flex-1 p-3 text-center font-semibold transition duration-150 ease-in-out bg-emerald-700 hover:bg-emerald-800">
                Chat Analyst
            </button>
            <button id="dashboard-tab" onclick="switchView('dashboard')" class="flex-1 p-3 text-center font-semibold transition duration-150 ease-in-out bg-emerald-600 hover:bg-emerald-700">
                Financial Dashboard
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT VIEW CONTAINER -->
    <div id="view-container" class="flex-grow flex flex-col">
        <!-- ----------------------- CHAT ANALYST VIEW ----------------------- -->
        <div id="chat-view" class="flex-grow flex flex-col">
            <!-- Data Summary Card -->
            <div id="data-card" class="p-4 bg-yellow-100 text-yellow-800 border-b border-yellow-300 flex-shrink-0">
                <p class="font-semibold">Simulated Data Loaded:</p>
                <p class="text-sm" id="data-stats">Generating 365+ transactions for 12 months...</p>
            </div>

            <!-- Chat Messages Area -->
            <main id="chat-area" class="chat-area space-y-4">
                <!-- Initial welcome message -->
                <div class="flex justify-start">
                    <div class="assistant-message message-box shadow-md">
                        Welcome! Preparing your personalized initial financial analysis now. Try asking "Show my profit and loss over time"!
                    </div>
                </div>
                <!-- Automated suggestions will be injected here on load -->
            </main>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="p-3 text-center text-sm text-gray-500 hidden flex-shrink-0">
                <div class="flex items-center justify-center space-x-2">
                    <span class="font-medium" id="loading-text">Analyzing Summary...</span>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>

            <!-- Input Area -->
            <footer class="input-area flex-shrink-0">

                <!-- Quick Question Buttons -->
                <div id="quick-questions" class="flex flex-wrap gap-2 mb-3 hidden">
                    <!-- Buttons will be dynamically inserted here -->
                </div>

                <div class="flex space-x-3">
                    <input type="text" id="user-input" placeholder="e.g., 'Show my profit and loss over time'"
                        class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 shadow-inner" disabled>

                    <!-- Microphone Button -->
                    <button id="mic-button"
                            class="bg-red-100 text-red-700 font-semibold py-3 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center"
                            onclick="startSpeechRecognition()" disabled>
                        <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.0" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5v3m0 0h.008v.008H12zm0 0h.008v.008H12zm0 0h.008v.008H12zM18.75 12a6 6 0 0 0-6-6h-1.5m-6 7.5a6 6 0 0 0 6 6v3m0 0h.008v.008H12zm0 0h.008v.008H12zm0 0h.008v.008H12zM12 3.75a4.5 4.5 0 0 0-4.5 4.5v3a4.5 4.5 0 0 0 9 0v-3a4.5 4.5 0 0 0-4.5-4.5z" />
                        </svg>
                    </button>

                    <!-- Send Button -->
                    <button id="send-button"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center"
                            onclick="sendMessage()" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.0" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.874L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </div>
            </footer>
        </div>

        <!-- ----------------------- DASHBOARD VIEW ----------------------- -->
        <div id="dashboard-view" class="dashboard-container hidden flex-grow overflow-y-auto">
            <h2 class="text-3xl font-extrabold text-red-700 mb-6 text-center">Your Financial Snapshot</h2>
            <div class="grid grid-cols-2 gap-4 w-full mb-8">
                <div class="metric-card bg-emerald-100 border-l-4 border-emerald-500">
                    <p class="text-sm font-medium text-gray-500">Net Savings</p>
                    <p id="net-savings-metric" class="text-xl font-bold text-emerald-800 mt-1">...</p>
                </div>
                <div class="metric-card bg-amber-100 border-l-4 border-amber-500">
                    <p class="text-sm font-medium text-gray-500">Investment % of Income</p>
                    <p id="investment-metric" class="text-xl font-bold text-amber-800 mt-1">...</p>
                </div>
            </div>

            <!-- Financial Triangle Visual -->
            <div class="bg-white p-4 rounded-xl shadow-lg border border-red-100 w-full mb-8 flex justify-center flex-col items-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Income Allocation (Re=Bel Triangle)</h3>
                <div id="triangle-visual" class="triangle-svg-wrapper">
                    <!-- SVG will be dynamically generated here -->
                </div>
            </div>

            <!-- Top Expenses and Insights -->
            <div class="w-full">
                <div class="p-4 bg-red-50 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-bold text-red-700 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Top 3 Expense Areas
                    </h3>
                    <ul id="top-expenses-list" class="space-y-2 text-gray-700 font-medium">
                        <li>Data loading...</li>
                    </ul>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Insight Summary</h3>
                    <p id="dashboard-insights" class="text-gray-700 text-sm italic">Data loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- DOM Elements ---
    const chatArea = document.getElementById('chat-area');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const micButton = document.getElementById('mic-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingText = document.getElementById('loading-text');
    const dataStats = document.getElementById('data-stats');
    const quickQuestionsDiv = document.getElementById('quick-questions'); // New element reference

    const chatView = document.getElementById('chat-view');
    const dashboardView = document.getElementById('dashboard-view');
    const chatTab = document.getElementById('chat-tab');
    const dashboardTab = document.getElementById('dashboard-tab');

    // Dashboard Elements
    const triangleVisual = document.getElementById('triangle-visual');
    const dashboardInsights = document.getElementById('dashboard-insights');
    const netSavingsMetric = document.getElementById('net-savings-metric');
    const investmentMetric = document.getElementById('investment-metric');
    const topExpensesList = document.getElementById('top-expenses-list');

    // ====================================================================
    // ?? CRITICAL STEP FOR LOCAL EXECUTION ??
    // You MUST replace the empty string below with your own valid Mistral API KEY.
    const API_KEY = "NsftRTjStEgCixsKl4FWtZaVjDN0v6fL"; // <-- INSERT YOUR Mistral API KEY HERE!
    // ====================================================================

    const MODEL_NAME = "mistral-7b"; // <-- UPDATE TO YOUR Mistral MODEL NAME HERE!
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    let transactionsData = [];
    let chatHistory = [];
    let financialSummary = '';
    let dashboardData = {}; // To store the ratios and metrics for the dashboard
    let recognition = null; // Speech recognition object
    let sendTimeoutId = null; // Timeout ID for the 5-second delay

    // --- System Prompts ---
    const systemPrompt = `You are a professional Financial Data Analyst. Your primary task is to analyze the 'Financial Summary Report' provided in the user's input string and provide a highly readable, structured response.
    1. **Keep the response extremely concise, using simple language suitable for a brief conversation.** The final response body must be under 150 words (excluding code blocks).
    2. Base all quantitative answers on the metrics within the Summary Report.
    3. All monetary amounts should be formatted with a Euro sign and two decimal places (e.g., Ä1,234.56).
    4. **Structure your response using Markdown.** Use bold text for key summaries and headings, and use bullet points or numbered lists to break down complex information or recommendations.
    5. When providing actionable recommendations, use **BOLD and CAPITALIZED text** within the recommendations list (e.g., "**INCREASE** investment contribution").
    6. For general financial advice (e.g., 'what is a Roth IRA'), use the Google Search tool, but still summarize the finding into a clear, structured explanation using bold and lists, maintaining brevity.
    7. **Crucially, always end with a conversational phrase offering more detail**, such as 'Would you like a more detailed breakdown?' or 'Let me know if you want to dive deeper into any of these points.'
    `;

    const autoSuggestSystemPrompt = `You are a professional Financial Data Analyst providing an initial client assessment.
    1. Analyze the 'Financial Summary Report' provided.
    2. Based ONLY on the specific prompt, provide ONE ultra-concise, actionable suggestion (under 50 words).
    3. **CRITICAL: Use Markdown (bold and bullet points) to format your suggestion for maximum clarity.** Use **BOLD and CAPITALIZED text** for the core action verb. Do NOT use Google Search.
    `;

    // --- Helper Functions ---

    function formatCurrency(amount) {
        // Updated to use 'EUR' and 'de-DE' locale for Euro formatting (e.g., 1.234,56 Ä)
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(amount);
    }

    function setControls(disabled, isMicActive = false) {
        userInput.disabled = disabled;
        sendButton.disabled = disabled;

        // Only enable the mic if the chat input is not disabled by the AI process
        micButton.disabled = disabled || isMicActive;

        // Toggle the visual state for the mic button
        micButton.classList.toggle('mic-listening', isMicActive);

        if (disabled) {
            loadingIndicator.classList.remove('hidden');
        } else {
            loadingIndicator.classList.add('hidden');
        }
    }

    /**
     * Handles click events for the quick question buttons.
     */
    window.handleQuickQuestion = function(query) {
        // Clear any existing voice timeout if the user submits manually
        if (sendTimeoutId) {
            clearTimeout(sendTimeoutId);
            sendTimeoutId = null;
        }
        userInput.value = query;
        sendMessage();
    }

    /**
     * Adds the quick question buttons to the UI.
     */
    function addQuickQuestionButtons() {
        const questions = [
            "Give me 3 budgeting tips",
            "What are some good investment ideas for beginners?",
            "How can I improve my credit score?",
            "What is the fastest way to repay high-interest debt?",
            "Tips for saving for a home down payment",
            "Explain the difference between a secured and unsecured loan."
        ];

        quickQuestionsDiv.innerHTML = questions.map(q => `
            <button onclick="handleQuickQuestion('${q.replace(/'/g, "\\'")}')"
                    class="bg-gray-200 text-gray-700 text-sm font-medium py-2 px-3 rounded-full hover:bg-emerald-100 transition duration-150 ease-in-out whitespace-nowrap shadow-sm">
                ${q}
            </button>
        `).join('');

        quickQuestionsDiv.classList.remove('hidden');
    }

    /**
     * Toggles between the chat view and the dashboard view.
     */
    window.switchView = function(view) {
        if (view === 'chat') {
            chatView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            chatTab.classList.add('bg-emerald-700');
            dashboardTab.classList.remove('bg-emerald-700');
        } else {
            chatView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            chatTab.classList.remove('bg-emerald-700');
            dashboardTab.classList.add('bg-emerald-700');
            renderDashboard(); // Ensure dashboard is rendered when switched to
        }
    }

    /**
     * Aggregates transactions into monthly income, expense, and net figures.
     */
    function getMonthlyData() {
        const monthlyData = {};
        transactionsData.forEach(t => {
            const monthYear = t.date.substring(0, 7); // YYYY-MM
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { income: 0, expense: 0 };
            }
            if (t.type === 'Income') {
                monthlyData[monthYear].income += t.amount;
            } else if (t.type === 'Expense') {
                monthlyData[monthYear].expense += t.amount;
            }
        });

        // Convert to array of objects, calculate net, and ensure sorting
        const formattedData = Object.keys(monthlyData).sort().map(key => {
            const { income, expense } = monthlyData[key];
            const net = income - expense;
            return {
                month: key,
                date: d3.timeParse("%Y-%m")(key), // Parse date object for D3
                income: parseFloat(income.toFixed(2)),
                expense: parseFloat(expense.toFixed(2)),
                net: parseFloat(net.toFixed(2))
            };
        });
        return formattedData;
    }

    /**
     * Renders a D3.js line chart showing monthly Income and Expense (P&L).
     */
    function renderChart(data, title) {
        const chartId = `chart-${Date.now()}`;

        // Create a container div for the chart in the chat area
        const chartContainer = document.createElement('div');
        chartContainer.className = 'flex justify-start w-full';
        chartContainer.innerHTML = `
            <div class="assistant-message message-box w-full max-w-full !p-0 shadow-xl border border-gray-300">
                <h3 class="font-bold text-lg p-3 bg-gray-200 rounded-t-xl text-gray-800">${title}</h3>
                <div id="${chartId}" class="p-1 w-full h-80 chart-container"></div>
                <div class="p-2 text-xs text-center text-gray-600 border-t border-gray-200">
                    Income (Green) vs. Expense (Red). Hover for details.
                </div>
            </div>
        `;
        chatArea.appendChild(chartContainer);
        chatArea.scrollTop = chatArea.scrollHeight;

        // D3 Chart Setup
        const margin = { top: 20, right: 30, bottom: 40, left: 60 };
        // Use an inner setTimeout to ensure the container is rendered and has a proper width
        setTimeout(() => {
            const chartElement = document.getElementById(chartId);
            if (!chartElement) return;

            const width = chartElement.clientWidth - margin.left - margin.right;
            const height = chartElement.clientHeight - margin.top - margin.bottom;

            const svg = d3.select(`#${chartId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // 1. Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            const yDomainMax = d3.max(data, d => Math.max(d.income, d.expense));
            const yDomainMin = d3.min(data, d => Math.min(d.income, d.expense, 0));

            const y = d3.scaleLinear()
                .domain([yDomainMin * 1.1, yDomainMax * 1.1])
                .range([height, 0]);

            // 2. Axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%b '%y")));

            svg.append("g")
                // Remove the currency symbol from the axis label, as it's often confusing with D3's automatic formatting
                .call(d3.axisLeft(y).tickFormat(d => formatCurrency(d).replace('Ä', '').trim()));

            // 3. Zero Line (for P&L reference)
            if (yDomainMin * 1.1 < 0) {
                svg.append("line")
                    .attr("x1", 0)
                    .attr("y1", y(0))
                    .attr("x2", width)
                    .attr("y2", y(0))
                    .attr("stroke", "#4b5563")
                    .attr("stroke-dasharray", "4");
            }

            // 4. Line Generators
            const lineIncome = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.income))
                .curve(d3.curveMonotoneX);

            const lineExpense = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.expense))
                .curve(d3.curveMonotoneX);

            // 5. Drawing Lines
            // Income Line
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#059669")
                .attr("stroke-width", 3)
                .attr("d", lineIncome);

            // Expense Line
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#b91c1c")
                .attr("stroke-width", 3)
                .attr("d", lineExpense);

            // 6. Tooltip/Interaction
            const focus = svg.append("g").style("display", "none");
            focus.append("circle").attr("r", 5).attr("fill", "#059669"); // Income marker
            focus.append("circle").attr("r", 5).attr("fill", "#b91c1c"); // Expense marker

            // Tooltip box background
            const tooltipRect = focus.append("rect")
                .attr("width", 150).attr("height", 45)
                .attr("rx", 5).attr("ry", 5)
                .attr("fill", "white")
                .attr("stroke", "#9ca3af")
                .style("filter", "drop-shadow(0 1px 2px rgba(0,0,0,0.2))");

            const tooltipText = focus.append("text").attr("font-size", "10px");
            const tooltipText1 = tooltipText.append("tspan").attr("x", 5).attr("dy", "1.2em");
            const tooltipText2 = tooltipText.append("tspan").attr("x", 5).attr("dy", "1.2em");
            const tooltipText3 = tooltipText.append("tspan").attr("x", 5).attr("dy", "1.2em");

            const bisectDate = d3.bisector(d => d.date).left;

            svg.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .on("mouseover", () => focus.style("display", null))
                .on("mouseout", () => focus.style("display", "none"))
                .on("mousemove", mousemove);

            function mousemove(event) {
                const x0 = x.invert(d3.pointer(event)[0]);
                const i = bisectDate(data, x0, 1);
                const d0 = data[i - 1];
                const d1 = data[i];
                const d = d1 && (x0 - d0.date > d1.date - x0) ? d1 : d0;

                focus.select("circle:nth-child(1)")
                    .attr("transform", `translate(${x(d.date)},${y(d.income)})`);
                focus.select("circle:nth-child(2)")
                    .attr("transform", `translate(${x(d.date)},${y(d.expense)})`);

                const netPL = d.income - d.expense;
                const monthYear = d3.timeFormat("%b %Y")(d.date);

                let xPos = x(d.date) + 15;
                let yPos = y(d.income) < height/2 ? y(d.income) - 10 : y(d.income) - 70; // Adjust position for visibility

                // Keep tooltip inside chart bounds
                if (xPos > width - 150) xPos = width - 165;
                if (yPos < 0) yPos = 5;

                focus.select("rect").attr("transform", `translate(${xPos},${yPos})`);
                focus.select("text").attr("transform", `translate(${xPos},${yPos})`);

                tooltipText1.text(monthYear);
                tooltipText2.text(`Inc: ${formatCurrency(d.income)} | Exp: ${formatCurrency(d.expense)}`);
                tooltipText3.text(`P&L: ${formatCurrency(netPL)}`).attr("fill", netPL >= 0 ? "#059669" : "#b91c1c");
            }
        }, 50); // Small delay to ensure DOM update
    }

    /**
     * Calculates the financial summary and key dashboard metrics.
     */
    function generateSummaryReport() {
        // ... (Summary report logic remains the same)
        const expenseData = transactionsData.filter(t => t.type === 'Expense');
        const incomeData = transactionsData.filter(t => t.type === 'Income');

        const totalIncome = incomeData.reduce((sum, t) => sum + t.amount, 0);
        const totalInvestment = expenseData.filter(t => t.category === 'Investment').reduce((sum, t) => sum + t.amount, 0);
        const nonInvestmentExpenses = expenseData.filter(t => t.category !== 'Investment').reduce((sum, t) => sum + t.amount, 0);

        const totalExpense = totalInvestment + nonInvestmentExpenses;
        const netSavings = totalIncome - totalExpense;
        const discretionarySavings = netSavings > 0 ? netSavings : 0;

        // Calculate spending by category (excluding Rent/Mortgage for focus)
        const spendingByCategory = expenseData
            .filter(t => t.category !== 'Investment' && t.category !== 'Rent/Mortgage')
            .reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

        // Sort categories to find the top spenders
        const sortedCategories = Object.entries(spendingByCategory)
            .sort(([, a], [, b]) => b - a);

        const topSpendingCategories = sortedCategories.slice(0, 3).map(([category, amount]) =>
            `${category}: ${formatCurrency(amount)}`
        );
        const topSpendingText = topSpendingCategories.join(' | ');

        // Calculate Proportions for the Dashboard Triangle (Total Income is the base 100%)
        const totalIncomeBase = totalIncome > 0 ? totalIncome : 1;

        const investmentRatio = totalInvestment / totalIncomeBase;
        const savingRatio = discretionarySavings / totalIncomeBase;
        const spendingRatio = nonInvestmentExpenses / totalIncomeBase;

        let totalRatio = investmentRatio + savingRatio + spendingRatio;
        if (totalRatio > 1) {
            const adjustment = totalRatio - 1;
            spendingRatio = Math.max(0, spendingRatio - adjustment);
            totalRatio = 1;
        }

        dashboardData = {
            investment: Math.round(investmentRatio * 100),
            saving: Math.round(savingRatio * 100),
            spending: Math.round(spendingRatio * 100),
            netSavings: netSavings,
            totalInvestment: totalInvestment,
            topExpenses: topSpendingCategories
        };

        // Format the report for the LLM
        return `
        --- Financial Summary Report (12 Months) ---
        Total Transactions: ${transactionsData.length}
        Total Income: ${formatCurrency(totalIncome)}
        Total Expenses: ${formatCurrency(totalExpense)}
        Net Savings (Profit/Loss): ${formatCurrency(netSavings)}
        Total Investment Contribution: ${formatCurrency(totalInvestment)}
        Spending Percentage of Income: ${dashboardData.spending}%
        Saving Percentage of Income: ${dashboardData.saving}%
        Investment Percentage of Income: ${dashboardData.investment}%
        Top 3 Non-Rent/Investment Spending Categories: ${topSpendingText}
        ------------------------------------------
        `;
    }

    /**
     * Renders the dedicated financial dashboard screen, including the labeled triangle.
     */
    function renderDashboard() {
        const { investment, saving, spending, netSavings, topExpenses } = dashboardData;

        // Colors
        const investmentColor = '#f59e0b'; // Amber (Investment)
        const savingColor = '#34d399'; // Green (Saving)
        const spendingColor = '#ef4444'; // Red (Spending)

        // Update Key Metrics
        netSavingsMetric.textContent = formatCurrency(netSavings);
        netSavingsMetric.classList.toggle('text-red-800', netSavings < 0);
        netSavingsMetric.classList.toggle('text-emerald-800', netSavings >= 0);

        investmentMetric.textContent = `${investment}%`;

        // Update Top Expenses List
        topExpensesList.innerHTML = topExpenses.map((item, index) => `
            <li class="flex justify-between items-center py-1">
                <span class="font-bold text-sm text-red-600">${index + 1}.</span>
                <span class="flex-grow ml-3">${item.split(': ')[0]}</span>
                <span class="font-semibold">${item.split(':')[1]}</span>
            </li>
        `).join('');

        // --- Triangle Visualization Logic ---
        const BASE_WIDTH = 100;
        const BASE_HEIGHT = 100;

        // Calculate dynamic height steps for the layers (from the top/apex down)
        let currentY = 0;

        const invH = (investment / 100) * BASE_HEIGHT;
        const savH = (saving / 100) * BASE_HEIGHT;
        const spdH = (spending / 100) * BASE_HEIGHT;

        // Investment layer (Top)
        let invY1 = currentY;
        currentY += invH;
        let invY2 = currentY;

        // Saving layer (Middle)
        let savY1 = currentY;
        currentY += savH;
        let savY2 = currentY;

        // Spending layer (Bottom)
        let spdY1 = currentY;
        currentY += spdH;
        let spdY2 = currentY;

        // Helper to get triangle points at a specific height Y
        const getPoints = (y) => {
            if (y < 0) y = 0;
            if (y > BASE_HEIGHT) y = BASE_HEIGHT;
            const w = BASE_WIDTH * (y / BASE_HEIGHT) / 2;
            return { w: w, x1: 50 - w, x2: 50 + w, y: y };
        };

        const invP1 = getPoints(invY1); // Apex (0, 0)
        const invP2 = getPoints(invY2);

        const savP1 = getPoints(savY1);
        const savP2 = getPoints(savY2);

        const spdP1 = getPoints(savY2);
        const spdP2 = getPoints(spdY2);

        // Adjust SVG ViewBox to provide padding for corner labels
        const PADDING_Y = 10;
        const SVG_HEIGHT = BASE_HEIGHT + 2 * PADDING_Y;
        const VIEWBOX_Y_START = -PADDING_Y;

        // SVG Content Generation
        const svgContent = `
            <svg viewBox="0 ${VIEWBOX_Y_START} ${BASE_WIDTH} ${SVG_HEIGHT}" preserveAspectRatio="xMidYMid meet" class="triangle-svg">
                <!-- Outer Border / Container -->
                <rect x="0" y="0" width="${BASE_WIDTH}" height="${BASE_HEIGHT}" fill="#fff"/>
                <polygon points="50,0 ${BASE_WIDTH},${BASE_HEIGHT} 0,${BASE_HEIGHT}" fill="none" stroke="#e5e7eb" stroke-width="0.5"/>

                <!-- Spending Layer (Bottom) - Using slightly less opacity for visual distinction -->
                <polygon points="${spdP1.x1},${spdP1.y} ${spdP2.x1},${spdP2.y} ${spdP2.x2},${spdP2.y} ${spdP1.x2},${spdP1.y}"
                         fill="${spendingColor}" fill-opacity="0.9">
                    <title>Spending: ${spending}%</title>
                </polygon>

                <!-- Saving Layer (Middle) -->
                <polygon points="${savP1.x1},${savP1.y} ${savP2.x1},${savP2.y} ${savP2.x2},${savP2.y} ${savP1.x2},${savP1.y}"
                         fill="${savingColor}" fill-opacity="0.9">
                    <title>Saving: ${saving}%</title>
                </polygon>

                <!-- Investment Layer (Top) -->
                <polygon points="50,${invP1.y} ${invP2.x2},${invP2.y} ${invP2.x1},${invP2.y}"
                         fill="${investmentColor}" fill-opacity="0.9">
                    <title>Investment: ${investment}%</title>
                </polygon>

                <!-- --- CORNER LABELS --- -->

                <!-- Top Corner: Investment -->
                <text x="50" y="-3" font-size="4" font-weight="bold" text-anchor="middle" fill="${investmentColor}">
                    INVESTMENT
                </text>
                <!-- Bottom Left Corner: Saving -->
                <text x="0" y="108" font-size="4" font-weight="bold" text-anchor="start" fill="${savingColor}">
                    SAVING
                </text>
                <!-- Bottom Right Corner: Spending -->
                <text x="100" y="108" font-size="4" font-weight="bold" text-anchor="end" fill="${spendingColor}">
                    SPENDING
                </text>

                <!-- Re=Bel Logo/Text -->
                <text x="50" y="50" font-family="Arial, sans-serif" font-size="8" font-weight="900" text-anchor="middle" fill="#dc2626">
                    Re=Bel
                </text>

                <!-- Center Percentage Labels (Inside the colored zones) -->
                ${investment > 5 ? `<text x="50" y="${invY1 + invH/2 + 1}" font-size="3.5" font-weight="bold" text-anchor="middle" fill="#fff">${investment}%</text>` : ''}
                ${saving > 5 ? `<text x="50" y="${savY1 + savH/2 + 1}" font-size="3.5" font-weight="bold" text-anchor="middle" fill="#1f2937">${saving}%</text>` : ''}
                ${spending > 5 ? `<text x="50" y="${spdY1 + spdH/2 + 1}" font-size="3.5" font-weight="bold" text-anchor="middle" fill="#fff">${spending}%</text>` : ''}

            </svg>
        `;

        triangleVisual.innerHTML = svgContent;

        // Update Insight Summary
        let insightText = '';
        if (netSavings >= 0) {
            insightText += `Your Net Savings are positive (${formatCurrency(netSavings)}), indicating a sustainable financial position. `;
        } else {
            insightText += `Caution: Your Net Savings are negative (${formatCurrency(netSavings)}). Immediate focus is needed to reduce expenses. `;
        }

        if (investment >= 10) {
            insightText += `Your ${investment}% allocation to Investment is healthy for long-term growth.`;
        } else if (saving > 15) {
            insightText += `You have strong savings habits, but consider moving ${saving}% of your current saving into long-term investments for better returns.`;
        } else {
            insightText += `Focus on controlling your top expenses (${topExpenses[0].split(':')[0]}) to free up capital for both saving and investing.`;
        }

        dashboardInsights.textContent = insightText;
    }

    /**
     * Generates a year's worth of simulated financial transactions.
     */
    function generateTransactions() {
        const categories = {
            Income: ['Salary', 'Freelance', 'Investment Return'],
            Expense: ['Rent/Mortgage', 'Groceries', 'Utilities', 'Transportation', 'Entertainment', 'Debt Payment', 'Investment', 'Travel', 'Health']
        };
        const numDays = 365;
        const startDate = new Date();
        startDate.setFullYear(startDate.getFullYear() - 1);
        let id = 1;
        let data = [];

        const baseIncome = 6000;
        const incomeVariance = 500;

        for (let i = 0; i <= numDays; i++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);
            const dateStr = currentDate.toISOString().substring(0, 10);

            if (currentDate.getDate() === 1 || currentDate.getDate() === 15) {
                const amount = baseIncome / 2 + (Math.random() - 0.5) * incomeVariance;
                data.push({
                    id: id++,
                    date: dateStr,
                    amount: parseFloat(amount.toFixed(2)),
                    type: 'Income',
                    category: 'Salary'
                });
            }

            const dailyTxnCount = Math.floor(Math.random() * 4) + 2;
            for (let j = 0; j < dailyTxnCount; j++) {
                if (Math.random() < 0.9) {
                    const category = categories.Expense[Math.floor(Math.random() * categories.Expense.length)];
                    let amount;
                    switch (category) {
                        case 'Rent/Mortgage':
                            if (j === 0 && currentDate.getDate() === 1) amount = 1500 + Math.random() * 200;
                            else continue;
                            break;
                        case 'Groceries':
                            amount = Math.random() < 0.1 ? 100 + Math.random() * 50 : 20 + Math.random() * 40;
                            break;
                        case 'Utilities':
                            if (j === 1 && currentDate.getDate() === 10) amount = 150 + Math.random() * 50;
                            else continue;
                            break;
                        case 'Entertainment':
                            amount = 10 + Math.random() * 70;
                            break;
                        case 'Investment':
                            if (j === 2 && currentDate.getDate() === 25) amount = 500 + Math.random() * 300;
                            else continue;
                            break;
                        case 'Debt Payment':
                             amount = 150 + Math.random() * 100;
                            break;
                        default:
                            amount = 5 + Math.random() * 50;
                            break;
                    }

                    if (amount) {
                         data.push({
                            id: id++,
                            date: dateStr,
                            amount: parseFloat(amount.toFixed(2)),
                            type: 'Expense',
                            category: category
                        });
                    }
                }
            }
        }
        return data;
    }

    /**
     * Helper to render messages in the chat UI, with robust Markdown parsing.
     */
    function displayMessage(text, role, sources = []) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message-box mt-3 shadow-md ${role === 'user' ? 'user-message' : 'assistant-message'}`;

        let htmlContent = '';
        let inList = false;

        // 1. Pre-process for block elements (Headers and Code Blocks)
        let preprocessedText = text;
        preprocessedText = preprocessedText.replace(/^###\s*(.*)$/gm, '<h3 class="text-lg font-bold mt-2">$1</h3>');
        preprocessedText = preprocessedText.replace(/^##\s*(.*)$/gm, '<h2 class="text-xl font-bold mt-3">$1</h2>');
        preprocessedText = preprocessedText.replace(/^#\s*(.*)$/gm, '<h1 class="text-2xl font-extrabold mt-4">$1</h1>');

        preprocessedText = preprocessedText.replace(/```json\n/g, '<pre class="bg-gray-200 p-2 rounded-lg overflow-x-auto text-sm text-gray-800">')
                                           .replace(/```/g, '</pre>');

        // 2. Line-by-line parsing for lists and paragraphs
        const lines = preprocessedText.split('\n');

        lines.forEach(line => {
            const trimmedLine = line.trim();
            const isListItem = trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ');

            // Check if we are ending a list block
            if (!isListItem && inList) {
                htmlContent += '</ul>';
                inList = false;
            }

            // Append content
            if (isListItem) {
                if (!inList) {
                    // Start a new list block
                    htmlContent += '<ul class="list-disc ml-4 space-y-1">';
                    inList = true;
                }
                // Extract content after the list marker
                const listItemContent = trimmedLine.substring(2).trim();
                // Apply inline formatting (bold)
                const listItemHtml = listItemContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                htmlContent += `<li>${listItemHtml}</li>`;

            } else if (trimmedLine && !trimmedLine.startsWith('<h') && !trimmedLine.startsWith('<pre')) {
                // If it's a non-list line with content, and not already a header or code block, wrap it in a paragraph
                const paragraphHtml = trimmedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                htmlContent += `<p class="mt-2">${paragraphHtml}</p>`;
            } else if (trimmedLine) {
                 // Preserve lines that are already block elements (like headers or code blocks)
                htmlContent += trimmedLine;
            }
            // If it's an empty line (no trimmed content), it is correctly ignored.
        });

        // 3. Close the list if we hit the end of the input while inside one
        if (inList) {
            htmlContent += '</ul>';
        }

        messageDiv.innerHTML = htmlContent;

        if (role === 'assistant' && sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'text-xs text-gray-700 mt-3 pt-2 border-t border-gray-400 italic font-medium';
            const sourceList = sources.map((source, index) => {
                const uri = source.uri && (source.uri.startsWith('http') ? source.uri : '#');
                return `<a href="${uri}" target="_blank" class="hover:underline text-emerald-800" title="${source.title || 'Source'}">Source ${index + 1}</a>`;
            }).join(', ');
            sourcesDiv.innerHTML = `Sources: ${sourceList}`;
            messageDiv.appendChild(sourcesDiv);
        }

        messageWrapper.appendChild(messageDiv);
        chatArea.appendChild(messageWrapper);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    /**
     * Initializes and starts the Web Speech Recognition API.
     */
    window.startSpeechRecognition = function() {
        if (!SpeechRecognition) {
            displayMessage("Your browser does not fully support the Web Speech API (Speech Recognition). Please use the text input.", 'assistant');
            micButton.disabled = true;
            return;
        }

        // Clear any existing timeout if the user starts speaking again
        if (sendTimeoutId) {
            clearTimeout(sendTimeoutId);
            sendTimeoutId = null;
        }

        if (recognition) {
            recognition.stop();
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            setControls(true, true);
            loadingText.textContent = "Listening... Speak now!";
        };

        recognition.onresult = (event) => {
            // Only update the input field with the captured transcript
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            loadingText.textContent = "Voice input failed or timed out. Please try again or type.";
            setControls(false, false);

            // Show a non-alert message for user feedback
            displayMessage(`Voice recognition error: ${event.error}. Please try typing your question.`, 'assistant');
        };

        recognition.onend = () => {
            const transcribedText = userInput.value.trim();

            if (transcribedText) {
                // Transcript captured. Set a 5-second delay before sending.
                loadingText.textContent = "Transcript captured. Waiting 5 seconds before analysis.";

                sendTimeoutId = setTimeout(() => {
                    // This block executes after the 5-second delay
                    sendTimeoutId = null; // Clear timeout ID
                    sendMessage(transcribedText);
                }, 5000); // 5000 milliseconds = 5 seconds
            } else {
                // No transcript captured
                setControls(false, false);
                loadingText.textContent = "Analysis Complete! Ask a question.";
            }
        };

        try {
            recognition.start();
        } catch (e) {
            console.error("Error starting recognition:", e);
            displayMessage("Microphone already in use or permission denied. Check your browser settings.", 'assistant');
            setControls(false, false);
        }
    }

    /**
     * Executes the initial, proactive analysis on load.
     */
    async function autoSuggestAnalysis() {
        setControls(true);
        loadingText.textContent = "Running initial financial assessment...";

        const analysisPrompts = [
            "Based on your net savings, suggest ONE achievable goal for long-term growth.",
            "Identify your highest expense category (excluding Rent) and give ONE simple way to adjust that spending.",
            "Given that it is late November and Christmas/New Year's is approaching, use your net savings data to suggest ONE specific, actionable way to budget for holiday gifts or travel."
        ];

        for (let i = 0; i < analysisPrompts.length; i++) {
            const userPrompt = analysisPrompts[i];

            const fullPrompt = `Analyze the following Financial Summary Report and answer ONLY the question: "${userPrompt}"

            Financial Summary Report:
            ${financialSummary}
            `;

            loadingText.textContent = `Analyzing Strategy ${i + 1} of ${analysisPrompts.length}...`;

            try {
                const { text } = await fetchMistralResponse(fullPrompt, [], autoSuggestSystemPrompt);
                displayMessage(text, 'assistant');
                await new Promise(resolve => setTimeout(resolve, 2000));

            } catch (error) {
                console.error(`?? Critical Error during auto-analysis for suggestion ${i + 1}:`, error);
                displayMessage(`(System Error during auto-analysis: Could not get suggestion ${i + 1}. This usually means the API Key is invalid or missing. See console for details.)`, 'assistant');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        displayMessage("That covers the most immediate areas! I'm now ready to answer any specific questions you have about your money. Try the microphone option!", 'assistant');
        loadingText.textContent = "Analysis Complete! Ask a question.";
        setControls(false, false);
        userInput.focus();

        // NEW: Show the quick question buttons after the initial analysis
        addQuickQuestionButtons();
    }

    /**
     * Handles sending the message and triggering the LLM call for manual questions.
     */
    window.sendMessage = async function(transcribedText = null) {
        const userQuery = transcribedText || userInput.value.trim();
        if (!userQuery) return;

        if (!API_KEY && typeof __initial_auth_token === 'undefined') {
            displayMessage("Error: AI functionality requires a valid **Mistral API Key**. Please update the `API_KEY` variable in the script.", 'assistant');
            console.error("Mistral API Key is missing. Update the 'API_KEY' variable for local execution.");
            return;
        }

        // Only display user message if it's not a delayed send (which was already transcribed)
        if (!transcribedText) {
             displayMessage(userQuery, 'user');
        }

        chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
        const graphKeywords = ["graph", "chart", "plot", "profit and loss over time", "p&l trend", "income expense trend"];

        if (graphKeywords.some(keyword => userQuery.toLowerCase().includes(keyword))) {
            // Intent is to show a graph
            const monthlyData = getMonthlyData();

            displayMessage(`Generating the P&L trend chart now for the last ${monthlyData.length} months.`, 'assistant');
            renderChart(monthlyData, "Monthly Income vs. Expense (Profit & Loss)");

            // Since we responded with a chart based on internal data, we skip the LLM call for the chat
            setControls(false);
            loadingText.textContent = "Analysis Complete! Ask a question.";
            userInput.focus();
            return;
        }

        const fullPrompt = `Analyze the following Financial Summary Report and answer my question based on its data.

        User Question: "${userQuery}"

        Financial Summary Report:
        ${financialSummary}
        `;

        userInput.value = '';
        setControls(true);
        loadingText.textContent = "Analyzing Question...";

        try {
            const { text, sources } = await fetchMistralResponse(fullPrompt, chatHistory, systemPrompt);

            displayMessage(text, 'assistant', sources);
            chatHistory.push({ role: "assistant", parts: [{ text: text }] });

        } catch (error) {
            console.error('Error fetching response:', error);
            displayMessage('Sorry, I encountered an error while analyzing the data. This is likely due to an incorrect API key or network issues. Please check the console for details.', 'assistant');
        } finally {
            setControls(false);
            loadingText.textContent = "Analysis Complete! Ask a question.";
            userInput.focus();
        }
    }

    /**
     * Calls the Mistral API with exponential backoff.
     */
    async function fetchMistralResponse(query, history, systemInstructionText) {
        const apiUrl = `https://api.mistral.ai/v1/chat/completions`; // <-- UPDATE TO YOUR Mistral API ENDPOINT HERE!

        const messages = history.map(msg => ({
            role: msg.role,
            content: msg.parts[0].text
        }));

        const payload = {
            model: MODEL_NAME,
            messages: messages,
            system: systemInstructionText
        };

        const maxRetries = 5;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Response Status:", response.status);
                    console.error("API Error Body:", errorBody);
                    throw new Error(`API call failed with status ${response.status}. This usually indicates a problem with the API key or quota.`);
                }

                const result = await response.json();
                const candidate = result.choices?.[0];

                if (candidate && candidate.message?.content) {
                    const text = candidate.message.content;
                    let sources = [];
                    if (payload.tools && candidate.groundingMetadata && candidate.groundingMetadata.groundingAttributions) {
                        sources = candidate.groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };

                } else {
                    throw new Error("Received an unexpected or empty response from the model.");
                }

            } catch (error) {
                if (i === maxRetries - 1) {
                    throw error;
                }
                console.warn(`Attempt ${i + 1} failed. Retrying...`, error.message);
            }
        }
        throw new Error("API request failed after multiple retries.");
    }

    // Initialization on load
    window.onload = () => {
        // 1. Generate Data
        transactionsData = generateTransactions();

        // 2. Generate and store the Financial Summary AND Dashboard Data
        financialSummary = generateSummaryReport();

        // 3. Extract key metrics for display in the summary card
        const totalIncome = transactionsData.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
        const totalExpense = transactionsData.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);

        // 4. Display Data Stats
        dataStats.innerHTML = `
            ${transactionsData.length} transactions generated over 12 months.<br>
            Total Simulated Income: <span class="font-bold text-emerald-800">${formatCurrency(totalIncome)}</span> |
            Total Simulated Expenses: <span class="font-bold text-red-800">${formatCurrency(totalExpense)}</span>
        `;

        // 5. Start the automated consultation
        autoSuggestAnalysis();

        // 6. Set up event listener for 'Enter' key
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !sendButton.disabled) {
                // Clear any existing voice timeout if the user submits manually
                if (sendTimeoutId) {
                    clearTimeout(sendTimeoutId);
                    sendTimeoutId = null;
                }
                sendMessage();
            }
        });

        // 7. Ensure chat is the default view
        switchView('chat');
    };

</script>
</body>
</html>
